<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.LightEpro.sch.mapper.SchMapper002">
    <select id="selectCalendarType" resultType="string">
        /* checkCalType */
        SELECT IFNULL(MAX(TSC.CAL_TYPE), '') AS calType
        FROM T_SC_CAL TSC
        WHERE 1 = 1
          AND TSC.CAL_SEQ = #{calendar.calSeq}
          AND TSC.USE_YND = 'Y'
    </select>

    <select id="selectScheduleCount" parameterType="com.example.LightEpro.sch.dto.sch002.SchRqDto002" resultType="int">
        /* selectScheduleCount */
        SELECT COUNT(1)
        FROM T_SC_SCH TSS
        WHERE 1 = 1
          AND TSS.SCHM_SEQ = #{schedule.schmSeq}
          AND TSS.SCH_SEQ = #{schedule.schSeq}
          AND TSS.USE_YND = 'Y'
    </select>
    
    <update id="updateSchedule" parameterType="com.example.LightEpro.sch.dto.sch002.SchRqDto002">
        /* updateSchedule */
        UPDATE T_SC_SCH TSS
        SET TSS.START_DATE       = #{schedule.startDate},
            TSS.START_DATE_YEAR  = #{schedule.startDateYear},
            TSS.START_DATE_MONTH = #{schedule.startDateMonth},
            TSS.END_DATE         = #{schedule.endDate},
            TSS.END_DATE_YEAR    = #{schedule.endDateYear},
            TSS.END_DATE_MONTH   = #{schedule.endDateMonth},
            TSS.ALL_DAY_YN       = #{schedule.alldayYn},
            TSS.SCH_TITLE        = #{schedule.schTitle},
            TSS.SCH_CONTENT      = #{schedule.schContent},
            TSS.MODIFY_DATE      = NOW(),
            TSS.MODIFY_SEQ       = #{schedule.modifySeq}
        WHERE 1 = 1
          AND TSS.SCHM_SEQ = #{schedule.schmSeq}
          AND TSS.SCH_SEQ = #{schedule.schSeq}
          AND TSS.USE_YND = 'Y'
    </update>

    <insert id="insertParticipants" parameterType="com.example.LightEpro.sch.dto.sch002.SchRqDto002">
        /* insertParticipants */
        INSERT INTO T_SC_SCH_USER (SCHM_SEQ,
                                    SCH_SEQ,
                                    CDE_SEQ,
                                    CDE_TYPE,
                                    SCH_PARTITION_TYPE,
                                    SCH_AUTORITY,
                                    CAL_SEQ,
                                    USE_YND,
                                    CREATE_DATE,
                                    CREATE_SEQ)
        VALUES <foreach collection="participants" item="participant" separator=",">
                (
                    #{schedule.schmSeq},
                    #{schedule.schSeq},
                    #{participant.cdeSeq},
                    #{participant.cdeType},
                    '10',
                    <choose>
                        <when test="participants.cdeSeq == user.userSeq">
                            'M'
                        </when>
                        <otherwise>
                            'W'
                        </otherwise>
                    </choose>,
                    <choose>
                        <when test="participant.cdeSeq == user.userSeq">
                            #{calendar.calSeq}
                        </when>
                        <otherwise>
                            '0'
                        </otherwise>
                    </choose>,
                    'Y',
                    now(),
                    #{user.userSeq}
                )
            </foreach>
    </insert>


    <insert id="insertDisclosureScopes" parameterType="com.example.LightEpro.sch.dto.sch002.SchRqDto002">
        /* insertDisclosureScopes */
        INSERT INTO T_SC_SCH_USER (SCHM_SEQ,
                                   SCH_SEQ,
                                   CDE_SEQ,
                                   CDE_TYPE,
                                   SCH_PARTITION_TYPE,
                                   SCH_AUTORITY,
                                   CAL_SEQ,
                                   USE_YND,
                                   CREATE_DATE,
                                   CREATE_SEQ)
        VALUES <foreach collection="disclosureScopes" item="disclosureScope" separator=",">
                (
                    #{schedule.schmSeq},
                    #{schedule.schSeq},
                    #{disclosureScope.cdeSeq},
                    #{disclosureScope.cdeType},
                    '20',
                    'S',
                    '0',
                    'Y',
                    now(),
                    #{user.userSeq}
                )
            </foreach>
    </insert>
</mapper>