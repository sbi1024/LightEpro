<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.LightEpro.sch.mapper.SchMapper000">
    <select id="selectUserCount" resultType="int">
        /* selectUserCount */
        SELECT COUNT(1)
        FROM T_EM_COMP TEC
                 INNER JOIN T_EM_DEPT TED
                            ON TEC.COMP_SEQ = TED.COMP_SEQ
                                AND TEC.USE_YND = 'Y'
                                AND TED.USE_YND = 'Y'
                 INNER JOIN T_EM_EMP TEE
                            ON TED.DEPT_SEQ = TEE.DEPT_SEQ
                                AND TEE.EMP_SEQ = TEE.EMP_SEQ
                                AND TEE.USE_YND = 'Y'
                 INNER JOIN T_EM_EMP_MAPPING TEEM
                            ON TEC.COMP_SEQ = TEEM.COMP_SEQ
                                AND TED.DEPT_SEQ = TEEM.DEPT_SEQ
                                AND TEE.EMP_SEQ = TEEM.EMP_SEQ
                                AND TEEM.USE_YND = 'Y'
                 INNER JOIN T_EM_EMP_ACCOUNT TEEA
                            ON TEEM.EMP_SEQ = TEEA.EMP_SEQ
                                AND TEEA.USE_YND = 'Y'
        WHERE 1 = 1
          AND TEC.COMP_SEQ = #{user.userCompSeq}
          AND TED.DEPT_SEQ = #{user.userDeptSeq}
          AND TEE.EMP_SEQ = #{user.userSeq}
    </select>

    <select id="selectCalendarType" resultType="string">
        /* checkCalType */
        SELECT IFNULL(MAX(TSC.CAL_TYPE), '') AS calType
        FROM T_SC_CAL TSC
        WHERE 1 = 1
          AND TSC.CAL_SEQ = #{calendar.calSeq}
          AND TSC.USE_YND = 'Y'
    </select>

    <select id = "selectScheduleSequence" resultType="int">
        /* findCurrentSchValue */
        SELECT practice.nextval('sch') FROM dual;
    </select>

    <insert id="insertSchedule" parameterType="com.example.LightEpro.sch.dto.sch000.SchRqDto000">
        /* insertSchedule */
        INSERT INTO T_SC_SCH (SCHM_SEQ,
                              SCH_SEQ,
                              START_DATE,
                              START_DATE_YEAR,
                              START_DATE_MONTH,
                              END_DATE,
                              END_DATE_YEAR,
                              END_DATE_MONTH,
                              ALL_DAY_YN,
                              SCH_TITLE,
                              SCH_CONTENT,
                              USE_YND,
                              CREATE_DATE,
                              CREATE_SEQ)
        VALUES (#{schedule.schmSeq},
                #{schedule.schSeq},
                #{schedule.startDate},
                #{schedule.startDateYear},
                #{schedule.startDateMonth},
                #{schedule.endDate},
                #{schedule.endDateYear},
                #{schedule.endDateMonth},
                #{schedule.allDayYn},
                #{schedule.schTitle},
                #{schedule.schContent},
                'Y',
                now(),
                #{user.userSeq})
    </insert>


    <insert id="insertParticipants" parameterType="java.util.List">
        /* insertParticipants */
        INSERT INTO T_SC_SCH_USER (SCHM_SEQ,
                                   SCH_SEQ,
                                   CDE_SEQ,
                                   CDE_TYPE,
                                   SCH_PARTITION_TYPE,
                                   SCH_AUTHORITY,
                                   CAL_SEQ,
                                   USE_YND,
                                   CREATE_DATE,
                                   CREATE_SEQ)
        VALUES <foreach collection="participants" item="participant" separator=",">
                    (
                        #{schedule.schmSeq},
                        #{schedule.schSeq},
                        #{participant.cdeSeq},
                        #{participant.cdeType},
                        '10',
                        <choose>
                            <when test="participant.cdeSeq == user.userSeq">
                                'M'
                            </when>
                            <otherwise>
                                'W'
                            </otherwise>
                        </choose>,
                        <choose>
                            <when test="participant.cdeSeq == user.userSeq">
                                #{calendar.calSeq}
                            </when>
                            <otherwise>
                                '0'
                            </otherwise>
                        </choose>,
                        'Y',
                        now(),
                        #{user.userSeq}
                    )
                </foreach>
    </insert>


    <insert id="insertDisclosureScopes" parameterType="java.util.List">
        /* insertDisclosureScopes */
        INSERT INTO T_SC_SCH_USER (SCHM_SEQ,
                                   SCH_SEQ,
                                   CDE_SEQ,
                                   CDE_TYPE,
                                   SCH_PARTITION_TYPE,
                                   SCH_AUTHORITY,
                                   CAL_SEQ,
                                   USE_YND,
                                   CREATE_DATE,
                                   CREATE_SEQ)
        VALUES <foreach collection="disclosureScopes" item="disclosureScope" separator=",">
                    (
                        #{schedule.schmSeq},
                        #{schedule.schSeq},
                        #{disclosureScope.cdeSeq},
                        #{disclosureScope.cdeType},
                        '20',
                        'R',
                        '0',
                        'Y',
                        now(),
                        #{user.userSeq}
                    )
             </foreach>
    </insert>
</mapper>