<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.LightEpro.sch.mapper.SchMapper007">
    <select id="selectUserCount" resultType="int">
        /* selectUserCount */
        SELECT COUNT(1)
        FROM T_EM_COMP TEC
                 INNER JOIN T_EM_DEPT TED
                            ON TEC.COMP_SEQ = TED.COMP_SEQ
                                AND TEC.USE_YND = 'Y'
                                AND TED.USE_YND = 'Y'
                 INNER JOIN T_EM_EMP TEE
                            ON TED.DEPT_SEQ = TEE.DEPT_SEQ
                                AND TEE.USE_YND = 'Y'
                 INNER JOIN T_EM_EMP_MAPPING TEEM
                            ON TEC.COMP_SEQ = TEEM.COMP_SEQ
                                AND TED.DEPT_SEQ = TEEM.DEPT_SEQ
                                AND TEE.EMP_SEQ = TEEM.EMP_SEQ
                                AND TEEM.USE_YND = 'Y'
                 INNER JOIN T_EM_EMP_ACCOUNT TEEA
                            ON TEEM.EMP_SEQ = TEEA.EMP_SEQ
                                AND TEEA.USE_YND = 'Y'
        WHERE 1 = 1
          AND TEC.COMP_SEQ = #{user.userCompSeq}
          AND TED.DEPT_SEQ = #{user.userDeptSeq}
          AND TEE.EMP_SEQ = #{user.userSeq}
    </select>

    <select id="selectCalendarCount" resultType="int">
        /* selectCalendarCount */
        SELECT COUNT(1)
        FROM T_SC_CAL TSC
        WHERE 1 = 1
          AND TSC.CAL_SEQ = #{calendar.calSeq}
          AND TSC.USE_YND = 'Y'
    </select>

    <select id="selectOriginOwner" resultType="int">
        /* selectOriginOwner */
        SELECT IFNULL(MAX(TSCU.CDE_SEQ), 0) AS cdeSeq
        FROM T_SC_CAL TSC
                 INNER JOIN T_SC_CAL_USER TSCU
                            ON TSC.CAL_SEQ = TSCU.CAL_SEQ
                                AND TSCU.CDE_TYPE = 'I'
                                AND TSCU.CAL_PARTITION_TYPE = 100
                                AND TSCU.CAL_AUTHORITY = 'M'
                                AND TSC.USE_YND = 'Y'
                                AND TSCU.USE_YND = 'Y'
        WHERE 1 = 1
          AND TSC.CAL_SEQ = #{calendar.calSeq}
    </select>

    <select id="selectManagers" resultType="com.example.LightEpro.sch.dto.sch007.SchRqDto007$Manager">
        /* selectManagers */
        SELECT IFNULL(TSCU.CDE_SEQ, '')                    AS cdeSeq,
               IFNULL(TSCU.CDE_TYPE, '')                   AS cdeType
        FROM T_SC_CAL_USER TSCU
        WHERE 1 = 1
          AND TSCU.CAL_SEQ = #{calendar.calSeq}
          AND TSCU.USE_YND = 'Y'
          AND TSCU.CAL_PARTITION_TYPE = 200
          AND TSCU.CAL_AUTHORITY = 'W'
    </select>

    <update id="updateCalendar" parameterType="com.example.LightEpro.sch.dto.sch007.SchRqDto007">
        /* updateCalendar */
        UPDATE T_SC_CAL TSC
        SET TSC.CAL_TITLE   = #{calendar.calTitle},
            TSC.CAL_TYPE    = #{calendar.calType},
            TSC.CAL_CONTENT = #{calendar.calContent},
            TSC.CAL_COLOR = <choose>
                                <when test="calendar.calColor == null or calendar.calColor == ''">
                                    '#748FFC'
                                </when>
                                <otherwise>
                                    #{calendar.calColor}
                                </otherwise>
                            </choose>,
            TSC.MODIFY_DATE = NOW(),
            TSC.MODIFY_SEQ  = #{user.userSeq}
        WHERE 1 = 1
          AND TSC.CAL_SEQ = #{calendar.calSeq}
          AND TSC.USE_YND = 'Y'
    </update>

    <update id="updateOwner">
        /* updateCalOwner */
        UPDATE T_SC_CAL_USER TSCU
        SET TSCU.MODIFY_DATE = NOW(),
            TSCU.MODIFY_SEQ  = #{user.userSeq}
        WHERE 1 = 1
          AND TSCU.CAL_SEQ = #{calendar.calSeq}
          AND TSCU.CAL_PARTITION_TYPE = 100
          AND TSCU.CAL_AUTHORITY = 'M'
          AND TSCU.USE_YND = 'Y'
    </update>

    <insert id="insertRequestNonMatchManagers" parameterType="com.example.LightEpro.sch.dto.sch007.SchRqDto007">
        /* insertRequestNonMatchManagers */
        INSERT INTO T_SC_CAL_USER (CAL_SEQ,
                                   CDE_SEQ,
                                   CDE_TYPE,
                                   CAL_PARTITION_TYPE,
                                   CAL_AUTHORITY,
                                   USE_YND,
                                   CREATE_DATE,
                                   CREATE_SEQ)
        VALUES <foreach collection="requestNonMatchManagers" item="requestNonMatchManager" separator=",">
                    (
                        #{calendar.calSeq},
                        #{requestNonMatchManager.cdeSeq},
                        #{requestNonMatchManager.cdeType},
                        200,
                        'W',
                        'Y',
                        NOW(),
                        #{user.userSeq}
                    )
               </foreach>
    </insert>

    <update id="updateOriginMatchManagers" parameterType="com.example.LightEpro.sch.dto.sch007.SchRqDto007">
        /* updateOriginMatchManagers */
        UPDATE T_SC_CAL_USER TSCU
        SET TSCU.MODIFY_DATE = NOW(),
        TSCU.MODIFY_SEQ = #{user.userSeq}
        WHERE 1 = 1
            AND (
                    <foreach collection="originMatchManagers" item="originMatchManager" open="(" separator="OR" close=")">
                        TSCU.CAL_SEQ = #{calendar.calSeq}
                        AND TSCU.CDE_SEQ = #{originMatchManager.cdeSeq}
                        AND TSCU.CDE_TYPE = #{originMatchManager.cdeType}
                        AND TSCU.CAL_PARTITION_TYPE = 200
                    </foreach>
                )
    </update>

    <delete id="deleteNonMatchManagers" parameterType="com.example.LightEpro.sch.dto.sch007.SchRqDto007">
        /* deleteNonMatchManagers */
        DELETE TSCU
        FROM T_SC_CAL_USER TSCU
        WHERE 1 = 1
         AND (
                 <foreach collection="originNonMatchManagers" item="originNonMatchManager" open="(" separator="OR" close=")">
                       TSCU.CAL_SEQ = #{calendar.calSeq}
                       AND TSCU.CDE_SEQ = #{originNonMatchManager.cdeSeq}
                       AND TSCU.CDE_TYPE = #{originNonMatchManager.cdeType}
                       AND TSCU.CAL_PARTITION_TYPE = 200
                 </foreach>
             )
    </delete>
</mapper>