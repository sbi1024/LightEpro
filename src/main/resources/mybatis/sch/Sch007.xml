<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.LightEpro.sch.mapper.SchMapper007">

    <select id="selectCalendarType" resultType="string">
        /* selectCalendarType */
        SELECT IFNULL(MAX(TSC.CAL_TYPE), '') AS calType
        FROM T_SC_CAL TSC
        WHERE 1 = 1
          AND TSC.CAL_SEQ = #{calendar.calSeq}
          AND TSC.USE_YND = 'Y'
    </select>

    <select id="selectOriginOwner" resultType="int">
        /* selectOriginOwner */
        SELECT IFNULL(MAX(TSCU.CDE_SEQ), '') AS cdeSeq
        FROM T_SC_CAL_USER TSCU
        WHERE 1 = 1
          AND TSCU.CAL_SEQ = #{calendar.calSeq}
          AND TSCU.CDE_TYPE = 'E'
          AND TSCU.CAL_PARTITION_TYPE = 100
          AND TSCU.CAL_AUTORITY = 'M'
          AND TSCU.USE_YND = 'Y'
    </select>

    <select id="selectManagers" resultType="com.example.LightEpro.sch.dto.sch007.SchRqDto007$Manager">
        /* selectManagers */
        SELECT IFNULL(TSCU.CDE_SEQ, '')                    AS cdeSeq,
               IFNULL(TSCU.CDE_TYPE, '')                   AS cdeType
        FROM T_SC_CAL_USER TSCU
        WHERE 1 = 1
          AND TSCU.CAL_SEQ = #{calendar.calSeq}
          AND TSCU.USE_YND = 'Y'
          AND TSCU.CAL_PARTITION_TYPE = 200
          AND TSCU.CAL_AUTORITY = 'W'
    </select>

    <update id="updateCalendar" parameterType="com.example.LightEpro.sch.dto.sch007.SchRqDto007">
        /* updateCalendar */
        UPDATE T_SC_CAL TSC
        SET TSC.CAL_TITLE   = #{calendar.calTitle},
            TSC.CAL_TYPE    = #{calendar.calType},
            TSC.CAL_CONTENT = #{calendar.calContent},
            TSC.CAL_COLOR   = #{calendar.calColor},
            TSC.MODIFY_DATE = NOW(),
            TSC.MODIFY_SEQ  = #{user.userSeq}
        WHERE 1 = 1
          AND TSC.CAL_SEQ = #{calendar.calSeq}
          AND TSC.USE_YND = 'Y'
    </update>

    <update id="updateOwner">
        /* updateCalOwner */
        UPDATE T_SC_CAL_USER TSCU
        SET TSCU.MODIFY_DATE = NOW(),
            TSCU.MODIFY_SEQ  = #{user.userSeq}
        WHERE 1 = 1
          AND TSCU.CAL_SEQ = #{calendar.calSeq}
          AND TSCU.CAL_PARTITION_TYPE = 100
          AND TSCU.CAL_AUTORITY = 'M'
          AND TSCU.USE_YND = 'Y'
    </update>

    <insert id="insertRequestNonMatchManagers" parameterType="com.example.LightEpro.sch.dto.sch007.SchRqDto007">
        /* insertRequestNonMatchManagers */
        INSERT INTO T_SC_CAL_USER (CAL_SEQ,
                                   CDE_SEQ,
                                   CDE_TYPE,
                                   CAL_PARTITION_TYPE,
                                   CAL_AUTORITY,
                                   USE_YND,
                                   CREATE_DATE,
                                   CREATE_SEQ)
        VALUES <foreach collection="requestNonMatchManagers" item="requestNonMatchManager" separator=",">
                    (
                        #{calendar.calSeq},
                        #{requestNonMatchManager.cdeSeq},
                        #{requestNonMatchManager.cdeType},
                        200,
                        'W',
                        'Y',
                        NOW(),
                        #{user.userSeq}
                    )
               </foreach>
               ON DUPLICATE KEY UPDATE
               USE_YND = 'Y',
               CREATE_DATE = NOW(),
               CREATE_SEQ = #{user.userSeq},
               MODIFY_DATE = NULL,
               MODIFY_SEQ = NULL
    </insert>

    <update id="updateOriginMatchManagers" parameterType="com.example.LightEpro.sch.dto.sch007.SchRqDto007">
        /* updateOriginMatchManagers */
        UPDATE T_SC_CAL_USER TSCU
        SET TSCU.MODIFY_DATE = NOW(),
        TSCU.MODIFY_SEQ = #{user.userSeq}
        WHERE 1 = 1
            AND (
                    <foreach collection="originMatchManagers" item="originMatchManager" open="(" separator="OR" close=")">
                        TSCU.CAL_SEQ = #{calendar.calSeq}
                        AND TSCU.CDE_SEQ = #{originMatchManager.cdeSeq}
                        AND TSCU.CDE_TYPE = #{originMatchManager.cdeType}
                        AND TSCU.CAL_PARTITION_TYPE = 200
                    </foreach>
                )
    </update>

    <update id="updateNonMatchManagers" parameterType="com.example.LightEpro.sch.dto.sch007.SchRqDto007">
        /* updateNonMatchManagers */
        UPDATE T_SC_CAL_USER TSCU
        SET TSCU.USE_YND = 'N' ,
            TSCU.MODIFY_DATE = NOW(),
            TSCU.MODIFY_SEQ = #{user.userSeq}
        WHERE 1 = 1
         AND (
                 <foreach collection="originNonMatchManagers" item="originNonMatchManager" open="(" separator="OR" close=")">
                       TSCU.CAL_SEQ = #{calendar.calSeq}
                       AND TSCU.CDE_SEQ = #{originNonMatchManager.cdeSeq}
                       AND TSCU.CDE_TYPE = #{originNonMatchManager.cdeType}
                       AND TSCU.CAL_PARTITION_TYPE = 200
                 </foreach>
             )
    </update>
</mapper>