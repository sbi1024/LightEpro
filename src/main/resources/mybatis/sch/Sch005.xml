<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.LightEpro.sch.mapper.SchMapper005">
    <select id="selectUserCount" resultType="int">
        /* selectUserCount */
        SELECT COUNT(1)
        FROM T_EM_COMP TEC
                 INNER JOIN T_EM_DEPT TED
                            ON TEC.COMP_SEQ = TED.COMP_SEQ
                                AND TEC.USE_YND = 'Y'
                                AND TED.USE_YND = 'Y'
                 INNER JOIN T_EM_EMP TEE
                            ON TED.DEPT_SEQ = TEE.DEPT_SEQ
                                AND TEE.EMP_SEQ = TEE.EMP_SEQ
                                AND TEE.USE_YND = 'Y'
                 INNER JOIN T_EM_EMP_MAPPING TEEM
                            ON TEC.COMP_SEQ = TEEM.COMP_SEQ
                                AND TED.DEPT_SEQ = TEEM.DEPT_SEQ
                                AND TEE.EMP_SEQ = TEEM.EMP_SEQ
                                AND TEEM.USE_YND = 'Y'
                 INNER JOIN T_EM_EMP_ACCOUNT TEEA
                            ON TEEM.EMP_SEQ = TEEA.EMP_SEQ
                                AND TEEA.USE_YND = 'Y'
        WHERE 1 = 1
          AND TEC.COMP_SEQ = #{user.userCompSeq}
          AND TED.DEPT_SEQ = #{user.userDeptSeq}
          AND TEE.EMP_SEQ = #{user.userSeq}
    </select>

    <select id="selectCalendarSequence" resultType="int">
        /* selectCalendarSequence */
        SELECT practice.nextval('cal')
        FROM dual;
    </select>

    <insert id="insertCalendar" parameterType="com.example.LightEpro.sch.dto.sch005.SchRqDto005">
        /* insertCalendar */
        INSERT INTO T_SC_CAL (CAL_SEQ,
                              CAL_TITLE,
                              CAL_CONTENT,
                              CAL_COLOR,
                              CAL_TYPE,
                              USE_YND,
                              CREATE_DATE,
                              CREATE_SEQ)
        VALUES (#{calendar.calSeq},
                #{calendar.calTitle},
                #{calendar.calContent},
                <choose>
                    <when test="calendar.calColor == null or calendar.calColor == ''">
                        '#748FFC'
                    </when>
                    <otherwise>
                        #{calendar.calColor}
                    </otherwise>
                </choose>,
                #{calendar.calType},
                'Y',
                NOW(),
                #{user.userSeq});
    </insert>

    <insert id="insertCalendarOwner" parameterType="com.example.LightEpro.sch.dto.sch005.SchRqDto005">
        /* insertCalendarOwner */
        INSERT INTO T_SC_CAL_USER (CAL_SEQ,
                                   CDE_SEQ,
                                   CDE_TYPE,
                                   CAL_PARTITION_TYPE,
                                   CAL_AUTHORITY,
                                   USE_YND,
                                   CREATE_DATE,
                                   CREATE_SEQ)
        VALUES (#{calendar.calSeq},
                #{owner.cdeSeq},
                #{owner.cdeType},
                100,
                'M',
                'Y',
                NOW(),
                #{user.userSeq})
    </insert>

    <insert id="insertCalendarManagers" parameterType="list">
        /* insertCalendarManagers */
        INSERT INTO T_SC_CAL_USER (CAL_SEQ,
                                   CDE_SEQ,
                                   CDE_TYPE,
                                   CAL_PARTITION_TYPE,
                                   CAL_AUTHORITY,
                                   USE_YND,
                                   CREATE_DATE,
                                   CREATE_SEQ)
        VALUES <foreach collection="managers" item="manager" separator=",">
                    (
                        #{calendar.calSeq},
                        #{manager.cdeSeq},
                        #{manager.cdeType},
                        200,
                        'W',
                        'Y',
                        NOW(),
                        #{user.userSeq}
                    )
                </foreach>
    </insert>
</mapper>